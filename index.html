<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Headphone Tool: Backup Server</title>
    <style>
        body { background: #0f0f0f; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { position: relative; width: 640px; height: 480px; background: #000; border: 2px solid #333; }
        video { display: none; }
        canvas { width: 100%; height: 100%; transform: scaleX(-1); }
        .hud { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.8); padding: 15px; border-radius: 8px; pointer-events: none; }
        .val { font-size: 32px; font-weight: bold; color: #00FFCC; display: block; }
        .status { position: absolute; bottom: 20px; width: 100%; text-align: center; pointer-events: none; color: yellow; font-weight: bold;}
    </style>
</head>
<body>

    <div class="container">
        <video class="input_video" playsinline></video>
        <canvas class="output_canvas" width="640" height="480"></canvas>
        <div class="hud">
            Width: <span id="width-out" class="val">--</span>
        </div>
        <div id="status" class="status">Connecting to Backup Server...</div>
    </div>

    <script src="https://unpkg.com/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    
   <script src="face_mesh.js"></script> crossorigin="anonymous"></script>

    <script>
        const statusEl = document.getElementById('status');
        const widthOut = document.getElementById('width-out');
        const canvasElement = document.querySelector('.output_canvas');
        const ctx = canvasElement.getContext('2d');
        const videoElement = document.querySelector('.input_video');

        async function startApp() {
            try {
                // Check if library loaded
                if (typeof FaceMesh === 'undefined') {
                    statusEl.innerText = "Error: Network blocked Unpkg server.";
                    statusEl.style.color = "red";
                    return;
                }

                statusEl.innerText = "Downloading AI Brain...";
                
                // Initialize with specific file locator
                const faceMesh = new FaceMesh({locateFile: (file) => {
                    return `https://unpkg.com/@mediapipe/face_mesh/${file}`;
                }});
                
                faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                faceMesh.onResults((results) => {
                    statusEl.innerText = "System Running";
                    statusEl.style.color = "#00FF00";
                    
                    ctx.clearRect(0, 0, 640, 480);
                    ctx.drawImage(results.image, 0, 0, 640, 480);
                    
                    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                        const face = results.multiFaceLandmarks[0];
                        const pL = {x: face[454].x * 640, y: face[454].y * 480};
                        const pR = {x: face[234].x * 640, y: face[234].y * 480};
                        
                        // Draw line
                        ctx.beginPath(); ctx.moveTo(pL.x, pL.y); ctx.lineTo(pR.x, pR.y);
                        ctx.strokeStyle = "#00FFCC"; ctx.lineWidth = 3; ctx.stroke();
                        
                        // Calculate
                        const scalePx = Math.sqrt(Math.pow(face[473].x*640 - face[468].x*640, 2) + Math.pow(face[473].y*480 - face[468].y*480, 2));
                        const mmPx = 63.0 / scalePx;
                        widthOut.innerText = (Math.sqrt(Math.pow(pL.x - pR.x, 2) + Math.pow(pL.y - pR.y, 2)) * mmPx).toFixed(1) + " mm";
                    }
                });

                await faceMesh.initialize();
                
                statusEl.innerText = "Starting Camera...";
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } });
                videoElement.srcObject = stream;
                await videoElement.play();

                const camera = new Camera(videoElement, {
                    onFrame: async () => { await faceMesh.send({image: videoElement}); },
                    width: 640, height: 480
                });
                await camera.start();

            } catch (err) {
                statusEl.innerText = "Error: " + err.message;
            }
        }
        
        // Wait 1 second to ensure scripts load
        setTimeout(startApp, 1000);
    </script>
</body>
</html>
